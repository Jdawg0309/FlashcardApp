{% extends "base.html" %}
{% block title %}Stats: {{ deck.name }}{% endblock %}

{% block content %}
  <h1 class="mb-4">Statistics for "{{ deck.name }}"</h1>

  <div class="row row-cols-1 row-cols-md-2 g-3 mb-4">
    <div class="col">
      <div class="card text-white bg-primary h-100">
        <div class="card-body">
          <h5 class="card-title">Total Cards</h5>
          <p class="card-text display-6">{{ total_cards }}</p>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card text-white bg-danger h-100">
        <div class="card-body">
          <h5 class="card-title">Cards Due Now</h5>
          <p class="card-text display-6">{{ due_cards }}</p>
        </div>
      </div>
    </div>
  </div>

  <h2 class="mb-3">Recent Reviews</h2>
  {% if logs %}
    <div class="table-responsive shadow-sm mb-5">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">Date</th>
            <th scope="col">Card ID</th>
            <th scope="col">Quality</th>
            <th scope="col">Interval (days)</th>
            <th scope="col">EFactor</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
            <tr>
              <td>{{ log.review_date.strftime("%Y-%m-%d %H:%M") }}</td>
              <td>{{ log.card_id }}</td>
              <td>{{ log.quality }}</td>
              <td>{{ log.interval_days }}</td>
              <td>{{ "%.2f"|format(log.efactor) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-secondary">
      No reviews logged yet.
    </div>
  {% endif %}

  <h2 class="mb-3">Reviews Over Time</h2>
  <canvas id="reviewsChart" width="400" height="200"></canvas>

  <div class="mt-4">
    <a href="{{ url_for('decks.deck_detail', deck_id=deck.id) }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Back to Deck
    </a>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const ctx = document.getElementById('reviewsChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ chart_dates|tojson }},
        datasets: [{
          label: 'Cards Reviewed',
          data: {{ chart_counts|tojson }},
          fill: false,
          tension: 0.1
        }]
      },
      options: {
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'Date'
            }
          },
          y: {
            display: true,
            title: {
              display: true,
              text: 'Count'
            },
            beginAtZero: true
          }
        }
      }
    });
  });
</script>
{% endblock %}
